
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gorome Aaram Leaderboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Sales & RX Leaderboard</h1>
        <p id="last-updated" class="text-sm text-gray-600 mb-4"></p>

        <input id="searchInput" type="text" placeholder="Search by Name or Code" class="p-2 border w-full mb-4 rounded">

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-2 px-4">RSM</th>
                        <th class="py-2 px-4">DSM</th>
                        <th class="py-2 px-4">CODE</th>
                        <th class="py-2 px-4">NAME</th>
                        <th class="py-2 px-4">Sales in Boxes</th>
                        <th class="py-2 px-4">Remaining for Gift Voucher</th>
                        <th class="py-2 px-4">Remaining for Fan</th>
                        <th class="py-2 px-4">RX</th>
                        <th class="py-2 px-4">RX Remaining for Gift Voucher</th>
                        <th class="py-2 px-4">RX Remaining for Fan</th>
                    </tr>
                </thead>
                <tbody id="leaderboard" class="text-center"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchData() {
            const salesResponse = await fetch('sales.xlsx');
            const rxResponse = await fetch('rx.xlsx');

            const salesData = await salesResponse.arrayBuffer();
            const rxData = await rxResponse.arrayBuffer();

            const salesWorkbook = XLSX.read(salesData);
            const rxWorkbook = XLSX.read(rxData);

            const salesSheet = salesWorkbook.Sheets[salesWorkbook.SheetNames[0]];
            const rxSheet = rxWorkbook.Sheets[rxWorkbook.SheetNames[0]];

            let salesJson = XLSX.utils.sheet_to_json(salesSheet);
            let rxJson = XLSX.utils.sheet_to_json(rxSheet);

            // Clean sales data (remove blanks)
            salesJson = salesJson.filter(row => row['RSM'] && row['CODE']);

            // Prepare RX mapping
            const rxMap = new Map();
            rxJson.forEach(row => {
                if(row['PSO Code']) {
                    rxMap.set(row['PSO Code'], row['RX Count'] || 0);
                }
            });

            const leaderboard = salesJson.map(row => {
                const salesQty = parseFloat(row['MTD QNTY']) || 0;
                const rxQty = parseFloat(rxMap.get(row['CODE'])) || 0;

                return {
                    rsm: row['RSM'] || '',
                    dsm: row['DSM'] || '',
                    code: row['CODE'] || '',
                    name: row['NAME'] || '',
                    sales: Math.round(salesQty),
                    salesGift: Math.max(140 - salesQty, 0),
                    salesFan: Math.max(180 - salesQty, 0),
                    rx: Math.round(rxQty),
                    rxGift: Math.max(140 - rxQty, 0),
                    rxFan: Math.max(180 - rxQty, 0)
                };
            });

            leaderboard.sort((a, b) => b.sales - a.sales);

            renderTable(leaderboard);
        }

        function renderTable(data) {
            const tbody = document.getElementById('leaderboard');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 px-4">${row.rsm}</td>
                    <td class="py-2 px-4">${row.dsm}</td>
                    <td class="py-2 px-4">${row.code}</td>
                    <td class="py-2 px-4">${row.name}</td>
                    <td class="py-2 px-4">${row.sales}</td>
                    <td class="py-2 px-4">${row.salesGift}</td>
                    <td class="py-2 px-4">${row.salesFan}</td>
                    <td class="py-2 px-4">${row.rx}</td>
                    <td class="py-2 px-4">${row.rxGift}</td>
                    <td class="py-2 px-4">${row.rxFan}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#leaderboard tr');

            rows.forEach(row => {
                const name = row.children[3].textContent.toLowerCase();
                const code = row.children[2].textContent.toLowerCase();
                if (name.includes(searchTerm) || code.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        document.getElementById('last-updated').innerText = `Last updated: ${new Date().toLocaleString()}`;

        fetchData();
    </script>
</body>
</html>
